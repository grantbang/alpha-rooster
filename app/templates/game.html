{% extends "base.html" %}

{% block title %}Spin to Win!{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
    .game-container {
        text-align: center;
    }

    #wheelCanvas {
        max-width: 400px;
        width: 100%;
        height: auto;
        margin: 30px auto;
        display: block;
    }

    #spinButton {
        margin-top: 20px;
    }

    #result {
        margin-top: 30px;
        padding: 20px;
        border-radius: 12px;
        display: none;
    }

    #result.show {
        display: block;
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        border: 3px solid #f39c12;
    }

    #result h2 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 28px;
    }

    #claimButton {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        margin-top: 15px;
    }

    #claimButton:hover {
        background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
    }

    .disclaimer {
        margin-top: 20px;
        font-size: 12px;
        color: #7f8c8d;
        line-height: 1.4;
    }
</style>
{% endblock %}

{% block content %}
<div class="container game-container">
    <h1>ðŸŽ¯ Spin the Wheel!</h1>
    <p class="subtitle">Click the button below to discover your reward tier</p>

    <canvas id="wheelCanvas" width="400" height="400"></canvas>

    <button id="spinButton">SPIN NOW</button>

    <div id="result">
        <h2>ðŸŽ‰ Congratulations!</h2>
        <p id="resultText"></p>
        <button id="claimButton">CLAIM YOUR REWARD</button>
    </div>

    <p class="disclaimer">
        By clicking "Claim Your Reward," you'll be redirected to our partner offer page.
        No purchase necessary. You're simply requesting a free quote.
    </p>
</div>

<script src="/static/js/wheel.js"></script>
<script>
    // Pass fbclid from backend to JavaScript
    const fbclid = "{{ fbclid }}";

    // Track ViewContent when game page loads
    if (typeof fbq !== 'undefined') {
        fbq('track', 'ViewContent', {
            content_name: 'Spin Wheel Game',
            content_category: 'Game',
            fbclid: fbclid
        });
        console.log('Meta Pixel: ViewContent tracked');
    }

    // Track when user clicks claim button
    document.getElementById('claimButton').addEventListener('click', function () {
        // Track InitiateCheckout event before redirect
        if (typeof fbq !== 'undefined') {
            fbq('track', 'InitiateCheckout', {
                content_name: 'Claim Reward',
                fbclid: fbclid
            });
            console.log('Meta Pixel: InitiateCheckout tracked');
        }

        // MaxBounty Auto Insurance Offer - YourInsurancePath (#29678)
        // SubID1 (s1) passes Facebook click ID for conversion tracking
        const offerUrl = `https://afflat3c1.com/trk/lnk/A41B827D-15FA-4B0B-AD52-0CAB1F1B1F18/?o=29678&c=918277&a=784915&k=EAA49755014524075AD2568514DBE364&l=33293&s1=${fbclid}`;
        console.log('Redirecting to offer:', offerUrl);

        // Small delay to ensure pixel fires
        setTimeout(() => {
            window.location.href = offerUrl;
        }, 300);
    });
</script>
{% endblock %}